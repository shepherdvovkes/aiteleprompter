<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Capture - Interview Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            min-height: 100vh;
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .device-item {
            transition: all 0.2s ease;
        }
        .device-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        .device-active {
            background: rgba(34, 197, 94, 0.2);
            border-color: rgba(34, 197, 94, 0.5);
        }
        .level-meter {
            height: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }
        .level-bar {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #f59e0b, #ef4444);
            transition: width 0.1s ease;
            border-radius: 10px;
        }
        .pulse-animation {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
    </style>
</head>
<body class="bg-gray-900 text-white">
    <div class="container mx-auto px-4 py-6">
        <!-- Header -->
        <div class="text-center mb-6">
            <h1 class="text-3xl font-bold mb-2">Audio Capture</h1>
            <p class="text-gray-300">–ó–∞—Ö–≤–∞—Ç –∞—É–¥–∏–æ –¥–ª—è –∏–Ω—Ç–µ—Ä–≤—å—é-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞</p>
        </div>

        <!-- Connection Status -->
        <div class="glass-effect rounded-lg p-4 mb-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div id="connection-status" class="w-3 h-3 rounded-full bg-red-500"></div>
                    <span id="connection-text">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É...</span>
                </div>
                <div class="text-sm">
                    –°—Ç–∞—Ç—É—Å –∑–∞—Ö–≤–∞—Ç–∞: <span id="capture-status" class="font-medium">–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω</span>
                </div>
            </div>
        </div>

        <!-- Controls -->
        <div class="glass-effect rounded-lg p-6 mb-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-xl font-semibold">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h2>
                <div class="flex space-x-3">
                    <button id="diagnose-vbcable" class="bg-yellow-600 hover:bg-yellow-700 px-4 py-2 rounded-lg font-medium transition-colors">
                        üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ VB-Cable
                    </button>
                    <button id="refresh-devices" class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg font-medium transition-colors">
                        –û–±–Ω–æ–≤–∏—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
                    </button>
                    <button id="start-capture" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg font-medium transition-colors">
                        –ù–∞—á–∞—Ç—å –∑–∞—Ö–≤–∞—Ç
                    </button>
                    <button id="stop-capture" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg font-medium transition-colors" disabled>
                        –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞—Ö–≤–∞—Ç
                    </button>
                </div>
            </div>
        </div>

        <!-- Audio Devices -->
        <div class="grid lg:grid-cols-2 gap-6 mb-6">
            <!-- Available Devices -->
            <div class="glass-effect rounded-lg p-6">
                <h3 class="text-lg font-semibold mb-4">–î–æ—Å—Ç—É–ø–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</h3>
                <div id="audio-devices" class="space-y-2">
                    <div class="text-gray-400 text-sm">–ó–∞–≥—Ä—É–∑–∫–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤...</div>
                </div>
            </div>

            <!-- Active Streams -->
            <div class="glass-effect rounded-lg p-6">
                <h3 class="text-lg font-semibold mb-4">–ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ—Ç–æ–∫–∏</h3>
                <div class="space-y-4">
                    <!-- P1 Stream -->
                    <div class="border border-red-500 border-opacity-30 rounded-lg p-4">
                        <div class="flex items-center justify-between mb-2">
                            <span class="font-medium text-red-400">P1 - –ò–Ω—Ç–µ—Ä–≤—å—é–µ—Ä (VB Cable)</span>
                            <span id="p1-stream-status" class="text-sm text-gray-400">–ù–µ–∞–∫—Ç–∏–≤–µ–Ω</span>
                        </div>
                        <div class="level-meter">
                            <div id="p1-level" class="level-bar" style="width: 0%"></div>
                        </div>
                    </div>

                    <!-- P2 Stream -->
                    <div class="border border-green-500 border-opacity-30 rounded-lg p-4">
                        <div class="flex items-center justify-between mb-2">
                            <span class="font-medium text-green-400">P2 - –°–æ–±–µ—Å–µ–¥–Ω–∏–∫ (–ú–∏–∫—Ä–æ—Ñ–æ–Ω)</span>
                            <span id="p2-stream-status" class="text-sm text-gray-400">–ù–µ–∞–∫—Ç–∏–≤–µ–Ω</span>
                        </div>
                        <div class="level-meter">
                            <div id="p2-level" class="level-bar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Test Section -->
        <div class="glass-effect rounded-lg p-6 mb-6">
            <h3 class="text-lg font-semibold mb-4">–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</h3>
            <div class="flex flex-wrap gap-3">
                <button id="test-p1" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg font-medium transition-colors">
                    –¢–µ—Å—Ç P1
                </button>
                <button id="test-p2" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg font-medium transition-colors">
                    –¢–µ—Å—Ç P2
                </button>
                <button id="test-devices" class="bg-yellow-600 hover:bg-yellow-700 px-4 py-2 rounded-lg font-medium transition-colors">
                    –¢–µ—Å—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤
                </button>
                <button id="test-vb-cable" class="bg-orange-600 hover:bg-orange-700 px-4 py-2 rounded-lg font-medium transition-colors">
                    üîß –¢–µ—Å—Ç VB-Cable
                </button>
                <button id="show-permissions" class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded-lg font-medium transition-colors">
                    –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è
                </button>
            </div>
        </div>

        <!-- Log -->
        <div class="glass-effect rounded-lg p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold">–õ–æ–≥ —Å–æ–±—ã—Ç–∏–π</h3>
                <button id="clear-log" class="text-sm bg-gray-600 hover:bg-gray-700 px-3 py-1 rounded transition-colors">
                    –û—á–∏—Å—Ç–∏—Ç—å
                </button>
            </div>
            <div id="log-container" class="bg-black bg-opacity-30 rounded-lg p-4 h-48 overflow-y-auto font-mono text-sm">
                <div class="text-gray-400">–û–∂–∏–¥–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π...</div>
            </div>
        </div>
    </div>

    <script src="js/audio-capture.js"></script>
    <script>
        class AudioCaptureUI {
            constructor() {
                this.audioCapture = null;
                this.isCapturing = false;
                this.levelAnimationId = null;
                
                this.initElements();
                this.bindEvents();
                this.initialize();
            }

            initElements() {
                this.connectionStatus = document.getElementById('connection-status');
                this.connectionText = document.getElementById('connection-text');
                this.captureStatus = document.getElementById('capture-status');
                
                this.diagnoseVBCableBtn = document.getElementById('diagnose-vbcable');
                this.refreshDevicesBtn = document.getElementById('refresh-devices');
                this.startCaptureBtn = document.getElementById('start-capture');
                this.stopCaptureBtn = document.getElementById('stop-capture');
                
                this.audioDevicesContainer = document.getElementById('audio-devices');
                this.p1StreamStatus = document.getElementById('p1-stream-status');
                this.p2StreamStatus = document.getElementById('p2-stream-status');
                this.p1Level = document.getElementById('p1-level');
                this.p2Level = document.getElementById('p2-level');
                
                this.testP1Btn = document.getElementById('test-p1');
                this.testP2Btn = document.getElementById('test-p2');
                this.testDevicesBtn = document.getElementById('test-devices');
                this.testVBCableBtn = document.getElementById('test-vb-cable');
                this.showPermissionsBtn = document.getElementById('show-permissions');
                
                this.logContainer = document.getElementById('log-container');
                this.clearLogBtn = document.getElementById('clear-log');
            }

            bindEvents() {
                this.diagnoseVBCableBtn.addEventListener('click', () => this.diagnoseVBCable());
                this.refreshDevicesBtn.addEventListener('click', () => this.refreshDevices());
                this.startCaptureBtn.addEventListener('click', () => this.startCapture());
                this.stopCaptureBtn.addEventListener('click', () => this.stopCapture());
                
                this.testP1Btn.addEventListener('click', () => this.testAudioChunk('P1'));
                this.testP2Btn.addEventListener('click', () => this.testAudioChunk('P2'));
                this.testDevicesBtn.addEventListener('click', () => this.testAllDevices());
                this.testVBCableBtn.addEventListener('click', () => this.diagnoseVBCable());
                this.showPermissionsBtn.addEventListener('click', () => this.checkPermissions());
                
                this.clearLogBtn.addEventListener('click', () => this.clearLog());
            }

            async initialize() {
                this.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞—É–¥–∏–æ –∑–∞—Ö–≤–∞—Ç–∞...', 'info');
                
                try {
                    this.audioCapture = new AudioCapture();
                    this.setupAudioCaptureEvents();
                    this.updateConnectionStatus('connecting');
                    
                    // Wait a bit for connection
                    setTimeout(() => {
                        if (this.audioCapture.ws && this.audioCapture.ws.readyState === WebSocket.OPEN) {
                            this.updateConnectionStatus('connected');
                        }
                    }, 1000);
                    
                    await this.refreshDevices();
                    this.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞', 'success');
                    
                } catch (error) {
                    this.log(`–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ${error.message}`, 'error');
                    this.updateConnectionStatus('error');
                }
            }

            setupAudioCaptureEvents() {
                // Override some methods to update UI
                const originalLog = console.log;
                const self = this;
                
                // Monitor WebSocket connection
                if (this.audioCapture.ws) {
                    this.audioCapture.ws.addEventListener('open', () => {
                        self.updateConnectionStatus('connected');
                    });
                    
                    this.audioCapture.ws.addEventListener('close', () => {
                        self.updateConnectionStatus('disconnected');
                    });
                }
            }

            updateConnectionStatus(status) {
                const statusConfig = {
                    'connecting': { color: 'bg-yellow-500', text: '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...' },
                    'connected': { color: 'bg-green-500', text: '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ' },
                    'disconnected': { color: 'bg-red-500', text: '–û—Ç–∫–ª—é—á–µ–Ω–æ' },
                    'error': { color: 'bg-red-500', text: '–û—à–∏–±–∫–∞' }
                };
                
                const config = statusConfig[status] || statusConfig.disconnected;
                this.connectionStatus.className = `w-3 h-3 rounded-full ${config.color}`;
                this.connectionText.textContent = config.text;
            }

            async refreshDevices() {
                this.log('–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤...', 'info');
                
                try {
                    const devices = await this.audioCapture.getAudioDevices();
                    this.renderDevices(devices);
                    this.log(`–ù–∞–π–¥–µ–Ω–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤: ${devices.length}`, 'info');
                } catch (error) {
                    this.log(`–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤: ${error.message}`, 'error');
                }
            }

            renderDevices(devices) {
                this.audioDevicesContainer.textContent = '';
                
                if (devices.length === 0) {
                    const noDevicesMsg = document.createElement('div');
                    noDevicesMsg.className = 'text-gray-400 text-sm';
                    noDevicesMsg.textContent = '–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã';
                    this.audioDevicesContainer.appendChild(noDevicesMsg);
                    return;
                }

                devices.forEach(device => {
                    const deviceItem = this.createDeviceElement(device);
                    this.audioDevicesContainer.appendChild(deviceItem);
                });
            }

            createDeviceElement(device) {
                const deviceDiv = document.createElement('div');
                deviceDiv.className = 'device-item border border-gray-600 rounded-lg p-3';
                
                // Create main container
                const flexContainer = document.createElement('div');
                flexContainer.className = 'flex items-center justify-between';
                
                // Create device info section
                const infoDiv = document.createElement('div');
                infoDiv.className = 'flex-1';
                
                const labelDiv = document.createElement('div');
                labelDiv.className = 'font-medium';
                labelDiv.textContent = device.label;
                
                const idDiv = document.createElement('div');
                idDiv.className = 'text-xs text-gray-400';
                idDiv.textContent = device.deviceId.substring(0, 20) + '...';
                
                infoDiv.appendChild(labelDiv);
                infoDiv.appendChild(idDiv);
                
                // Create controls section
                const controlsDiv = document.createElement('div');
                controlsDiv.className = 'flex items-center space-x-2';
                
                // Add VB Cable badge if needed
                if (device.isVBCable) {
                    const badge = document.createElement('span');
                    badge.className = 'bg-red-500 text-xs px-2 py-1 rounded';
                    badge.textContent = 'VB Cable';
                    controlsDiv.appendChild(badge);
                }
                
                // Add test button
                const testBtn = document.createElement('button');
                testBtn.className = 'bg-blue-600 hover:bg-blue-700 text-xs px-2 py-1 rounded transition-colors';
                testBtn.textContent = '–¢–µ—Å—Ç';
                testBtn.addEventListener('click', () => {
                    this.testDevice(device.deviceId);
                });
                controlsDiv.appendChild(testBtn);
                
                // Assemble the element
                flexContainer.appendChild(infoDiv);
                flexContainer.appendChild(controlsDiv);
                deviceDiv.appendChild(flexContainer);
                
                return deviceDiv;
            }

            async testDevice(deviceId) {
                this.log(`–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞: ${deviceId.substring(0, 20)}...`, 'info');
                
                try {
                    const result = await this.audioCapture.testAudioInput(deviceId);
                    
                    if (result.error) {
                        this.log(`–û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: ${result.error}`, 'error');
                    } else {
                        this.log(`–¢–µ—Å—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞: –º–∞–∫—Å. –≥—Ä–æ–º–∫–æ—Å—Ç—å ${result.maxVolume.toFixed(1)}, —Å–∏–≥–Ω–∞–ª: ${result.hasSignal ? '–µ—Å—Ç—å' : '–Ω–µ—Ç'}`, 
                                 result.hasSignal ? 'success' : 'warning');
                    }
                } catch (error) {
                    this.log(`–û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞: ${error.message}`, 'error');
                }
            }

            async testAllDevices() {
                this.log('–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤...', 'info');
                
                try {
                    const devices = await this.audioCapture.getAudioDevices();
                    
                    for (const device of devices) {
                        await this.testDevice(device.deviceId);
                        await new Promise(resolve => setTimeout(resolve, 500)); // Small delay between tests
                    }
                    
                    this.log('–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–æ', 'success');
                } catch (error) {
                    this.log(`–û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤: ${error.message}`, 'error');
                }
            }

            async diagnoseVBCable() {
                this.log('üîç –ù–∞—á–∏–Ω–∞—é –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É VB-Cable...', 'info');
                
                try {
                    // Check if VB-Cable is installed (check available devices)
                    const devices = await navigator.mediaDevices.enumerateDevices();
                    const audioInputs = devices.filter(device => device.kind === 'audioinput');
                    
                    this.log(`–ù–∞–π–¥–µ–Ω–æ –∞—É–¥–∏–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤: ${audioInputs.length}`, 'info');
                    
                    // Look for VB-Cable devices
                    const vbCableDevices = audioInputs.filter(device => 
                        device.label.toLowerCase().includes('cable') || 
                        device.label.toLowerCase().includes('vb-audio') ||
                        device.label.toLowerCase().includes('vb cable') ||
                        device.label.toLowerCase().includes('vbcable') ||
                        device.label.toLowerCase().includes('virtual audio cable')
                    );
                    
                    if (vbCableDevices.length === 0) {
                        this.log('‚ùå VB-Cable —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ', 'error');
                        this.log('üìã –î–æ—Å—Ç—É–ø–Ω—ã–µ –∞—É–¥–∏–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞:', 'info');
                        audioInputs.forEach((device, index) => {
                            this.log(`${index + 1}. ${device.label}`, 'info');
                        });
                        
                        this.log('üí° –í–æ–∑–º–æ–∂–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è:', 'warning');
                        this.log('1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ VB-Cable —Å –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–≥–æ —Å–∞–π—Ç–∞: https://vb-audio.com/Cable/', 'warning');
                        this.log('2. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –±—Ä–∞—É–∑–µ—Ä –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏', 'warning');
                        this.log('3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–≤—É–∫–∞ –≤ —Å–∏—Å—Ç–µ–º–µ', 'warning');
                        return;
                    }
                    
                    this.log(`‚úÖ –ù–∞–π–¥–µ–Ω–æ VB-Cable —É—Å—Ç—Ä–æ–π—Å—Ç–≤: ${vbCableDevices.length}`, 'success');
                    vbCableDevices.forEach((device, index) => {
                        this.log(`${index + 1}. ${device.label}`, 'success');
                    });
                    
                    // Test each VB-Cable device
                    for (const device of vbCableDevices) {
                        this.log(`üß™ –¢–µ—Å—Ç–∏—Ä—É—é: ${device.label}`, 'info');
                        
                        try {
                            const stream = await navigator.mediaDevices.getUserMedia({
                                audio: {
                                    deviceId: { exact: device.deviceId },
                                    echoCancellation: false,
                                    noiseSuppression: false,
                                    autoGainControl: false
                                }
                            });
                            
                            this.log(`‚úÖ –£—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω –ø–æ—Ç–æ–∫ –æ—Ç: ${device.label}`, 'success');
                            
                            // Test audio levels
                            const audioContext = new AudioContext();
                            const source = audioContext.createMediaStreamSource(stream);
                            const analyser = audioContext.createAnalyser();
                            source.connect(analyser);
                            
                            const dataArray = new Uint8Array(analyser.frequencyBinCount);
                            let maxLevel = 0;
                            let testCount = 0;
                            
                            const testAudio = () => {
                                analyser.getByteTimeDomainData(dataArray);
                                let sum = 0;
                                for (let i = 0; i < dataArray.length; i++) {
                                    const sample = (dataArray[i] - 128) / 128;
                                    sum += sample * sample;
                                }
                                const rms = Math.sqrt(sum / dataArray.length);
                                const level = rms * 100;
                                maxLevel = Math.max(maxLevel, level);
                                testCount++;
                                
                                if (testCount < 50) { // Test for ~1 second
                                    requestAnimationFrame(testAudio);
                                } else {
                                    stream.getTracks().forEach(track => track.stop());
                                    audioContext.close();
                                    
                                    if (maxLevel < 1) {
                                        this.log(`‚ö†Ô∏è ${device.label}: –ù–µ—Ç –∞—É–¥–∏–æ —Å–∏–≥–Ω–∞–ª–∞ (—É—Ä–æ–≤–µ–Ω—å: ${maxLevel.toFixed(2)}%)`, 'warning');
                                        this.log('üí° –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∞—É–¥–∏–æ –∏—Å—Ç–æ—á–Ω–∏–∫ (Zoom/Meet) –Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –∑–≤—É–∫ –≤ VB-Cable', 'warning');
                                    } else {
                                        this.log(`‚úÖ ${device.label}: –ï—Å—Ç—å –∞—É–¥–∏–æ —Å–∏–≥–Ω–∞–ª (–º–∞–∫—Å. —É—Ä–æ–≤–µ–Ω—å: ${maxLevel.toFixed(2)}%)`, 'success');
                                    }
                                }
                            };
                            
                            testAudio();
                            
                        } catch (deviceError) {
                            this.log(`‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è ${device.label}: ${deviceError.message}`, 'error');
                        }
                        
                        // Small delay between device tests
                        await new Promise(resolve => setTimeout(resolve, 1500));
                    }
                    
                    // Check microphone permissions
                    if (navigator.permissions) {
                        try {
                            const permission = await navigator.permissions.query({ name: 'microphone' });
                            this.log(`üé§ –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞: ${permission.state}`, 
                                    permission.state === 'granted' ? 'success' : 'warning');
                        } catch (permError) {
                            this.log('‚ÑπÔ∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞', 'info');
                        }
                    }
                    
                    this.log('üèÅ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ VB-Cable –∑–∞–≤–µ—Ä—à–µ–Ω–∞', 'success');
                    
                } catch (error) {
                    this.log(`‚ùå –û—à–∏–±–∫–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏: ${error.message}`, 'error');
                }
            }

            async startCapture() {
                if (this.isCapturing) return;
                
                this.log('–ó–∞–ø—É—Å–∫ –∑–∞—Ö–≤–∞—Ç–∞ –∞—É–¥–∏–æ...', 'info');
                
                try {
                    await this.audioCapture.startCapture();
                    this.isCapturing = true;
                    this.updateCaptureStatus(true);
                    this.startLevelAnimation();
                    this.log('–ó–∞—Ö–≤–∞—Ç –∞—É–¥–∏–æ –∑–∞–ø—É—â–µ–Ω', 'success');
                } catch (error) {
                    this.log(`–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∑–∞—Ö–≤–∞—Ç–∞: ${error.message}`, 'error');
                }
            }

            async stopCapture() {
                if (!this.isCapturing) return;
                
                this.log('–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞—Ö–≤–∞—Ç–∞ –∞—É–¥–∏–æ...', 'info');
                
                try {
                    this.audioCapture.stopCapture();
                    this.isCapturing = false;
                    this.updateCaptureStatus(false);
                    this.stopLevelAnimation();
                    this.log('–ó–∞—Ö–≤–∞—Ç –∞—É–¥–∏–æ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω', 'success');
                } catch (error) {
                    this.log(`–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∑–∞—Ö–≤–∞—Ç–∞: ${error.message}`, 'error');
                }
            }

            updateCaptureStatus(capturing) {
                this.captureStatus.textContent = capturing ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω';
                this.captureStatus.className = capturing ? 'font-medium text-green-400 pulse-animation' : 'font-medium text-gray-400';
                
                this.startCaptureBtn.disabled = capturing;
                this.stopCaptureBtn.disabled = !capturing;
                
                // Update stream statuses
                if (capturing) {
                    this.p1StreamStatus.textContent = '–ê–∫—Ç–∏–≤–µ–Ω';
                    this.p1StreamStatus.className = 'text-sm text-red-400';
                    this.p2StreamStatus.textContent = '–ê–∫—Ç–∏–≤–µ–Ω';
                    this.p2StreamStatus.className = 'text-sm text-green-400';
                } else {
                    this.p1StreamStatus.textContent = '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω';
                    this.p1StreamStatus.className = 'text-sm text-gray-400';
                    this.p2StreamStatus.textContent = '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω';
                    this.p2StreamStatus.className = 'text-sm text-gray-400';
                }
            }

            startLevelAnimation() {
                const animate = () => {
                    if (!this.isCapturing) return;
                    
                    // Get real audio levels from AudioCapture
                    const levels = this.audioCapture.getAudioLevels();
                    const p1Level = levels.p1 || 0;
                    const p2Level = levels.p2 || 0;
                    
                    this.p1Level.style.width = `${p1Level}%`;
                    this.p2Level.style.width = `${p2Level}%`;
                    
                    this.levelAnimationId = requestAnimationFrame(animate);
                };
                
                animate();
            }

            stopLevelAnimation() {
                if (this.levelAnimationId) {
                    cancelAnimationFrame(this.levelAnimationId);
                    this.levelAnimationId = null;
                }
                
                this.p1Level.style.width = '0%';
                this.p2Level.style.width = '0%';
            }

            async testAudioChunk(personType) {
                this.log(`–û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —á–∞–Ω–∫–∞ –¥–ª—è ${personType}...`, 'info');
                
                try {
                    await this.audioCapture.sendTestChunk(personType);
                    this.log(`–¢–µ—Å—Ç–æ–≤—ã–π —á–∞–Ω–∫ –¥–ª—è ${personType} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω`, 'success');
                } catch (error) {
                    this.log(`–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —á–∞–Ω–∫–∞: ${error.message}`, 'error');
                }
            }

            async checkPermissions() {
                this.log('–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π...', 'info');
                
                try {
                    // Check microphone permission
                    const micPermission = await navigator.permissions.query({ name: 'microphone' });
                    this.log(`–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞: ${micPermission.state}`, 
                             micPermission.state === 'granted' ? 'success' : 'warning');
                    
                    // Try to get user media to trigger permission if needed
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    stream.getTracks().forEach(track => track.stop());
                    this.log('–î–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –ø–æ–ª—É—á–µ–Ω', 'success');
                    
                } catch (error) {
                    this.log(`–û—à–∏–±–∫–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π: ${error.message}`, 'error');
                }
            }

            log(message, type = 'info') {
                const time = new Date().toLocaleTimeString();
                const typeColors = {
                    'info': 'text-blue-300',
                    'success': 'text-green-300',
                    'warning': 'text-yellow-300',
                    'error': 'text-red-300'
                };
                
                const logEntry = document.createElement('div');
                logEntry.className = `${typeColors[type] || typeColors.info} mb-1`;
                
                const timeSpan = document.createElement('span');
                timeSpan.className = 'text-gray-500';
                timeSpan.textContent = `[${time}]`;
                
                const messageSpan = document.createElement('span');
                messageSpan.textContent = ` ${message}`;
                
                logEntry.appendChild(timeSpan);
                logEntry.appendChild(messageSpan);
                
                this.logContainer.appendChild(logEntry);
                this.logContainer.scrollTop = this.logContainer.scrollHeight;
                
                // Limit log entries
                const entries = this.logContainer.children;
                if (entries.length > 100) {
                    this.logContainer.removeChild(entries[0]);
                }
            }

            clearLog() {
                this.logContainer.textContent = '';
                const logMsg = document.createElement('div');
                logMsg.className = 'text-gray-400';
                logMsg.textContent = '–õ–æ–≥ –æ—á–∏—â–µ–Ω';
                this.logContainer.appendChild(logMsg);
            }
        }

        // Initialize UI
        let audioCaptureUI;
        document.addEventListener('DOMContentLoaded', () => {
            audioCaptureUI = new AudioCaptureUI();
        });
    </script>
</body>
</html>